# 项目结构说明

## 目录结构

```
智能标书审查系统/
│
├── app.py                      # 【核心】Streamlit 主应用程序
│   ├── 文件上传功能
│   ├── 标书分析界面
│   └── 投标文件生成界面
│
├── modules/                    # 【核心模块】
│   ├── __init__.py            # 模块初始化
│   ├── document_parser.py     # 文档解析模块
│   │   ├── PDF 解析（PyMuPDF）
│   │   ├── Word 解析（python-docx）
│   │   └── Excel 解析（openpyxl/pandas）
│   │
│   ├── ai_service.py          # Claude AI 服务封装
│   │   ├── 标书分析
│   │   ├── 投标文件生成
│   │   └── 通用对话接口
│   │
│   └── database.py            # 数据库管理
│       ├── SQLite 数据库操作
│       ├── 项目记录 CRUD
│       └── 历史记录查询
│
├── uploads/                    # 【运行时生成】上传文件存储目录
│   └── (用户上传的 PDF/Word/Excel 文件)
│
├── data/                       # 【运行时生成】数据库文件目录
│   └── bidding_system.db      # SQLite 数据库
│
├── requirements.txt            # Python 依赖包列表
├── .env.example               # 环境变量配置模板
├── .env                       # 【需用户创建】实际环境配置
├── .gitignore                 # Git 忽略文件配置
│
├── README.md                  # 项目说明文档
├── 使用指南.md                # 详细使用教程
├── 项目结构说明.md            # 本文件
│
├── test_setup.py              # 环境配置测试脚本
├── start.bat                  # Windows 启动脚本
└── start.sh                   # Mac/Linux 启动脚本
```

## 核心模块详解

### 1. app.py - 主应用程序

**功能**：
- Streamlit Web 界面
- 三个主要标签页：文件上传、标书分析、投标生成
- Session 状态管理
- 历史记录加载

**关键函数**：
- `main()`: 主函数，组织整体界面
- `file_upload_tab()`: 文件上传界面
- `analysis_tab()`: 标书分析界面
- `generation_tab()`: 投标文件生成界面
- `load_record()`: 加载历史记录
- `reset_session()`: 重置会话

### 2. modules/document_parser.py - 文档解析

**功能**：
- 支持 PDF、Word、Excel 格式文件解析
- 提取文本内容和元数据

**核心类**：
- `DocumentParser`: 文档解析器主类
  - `parse()`: 通用解析入口
  - `parse_pdf()`: PDF 解析
  - `parse_word()`: Word 解析（含表格）
  - `parse_excel()`: Excel 解析（多工作表）

**返回格式**：
```python
{
    'content': '提取的文本内容',
    'metadata': {
        'type': '文件类型',
        'pages': 页数,  # PDF
        'file_name': '文件名'
    }
}
```

### 3. modules/ai_service.py - AI 服务

**功能**：
- 封装 Anthropic Claude API 调用
- 提供标书分析和投标生成功能

**核心类**：
- `ClaudeService`: Claude AI 服务封装
  - `analyze_bidding_document()`: 分析标书
  - `generate_bidding_response()`: 生成投标文件
  - `chat()`: 通用对话接口
  - `_build_analysis_prompt()`: 构建分析提示词
  - `_build_generation_prompt()`: 构建生成提示词

**配置**：
- 默认模型：`claude-sonnet-4-20250514`
- 可选模型：`claude-opus-4-20250514`（更强但成本高）

### 4. modules/database.py - 数据库管理

**功能**：
- SQLite 数据库操作
- 项目记录的增删改查

**核心类**：
- `BiddingRecord`: 数据模型（ORM）
  - `id`: 主键
  - `project_name`: 项目名称
  - `uploaded_files`: 上传文件信息（JSON）
  - `analysis_report`: 分析报告
  - `bidding_response`: 投标文件
  - `status`: 状态（draft/analyzed/completed）
  - `create_time/update_time`: 时间戳

- `DatabaseManager`: 数据库管理器
  - `create_record()`: 创建记录
  - `update_record()`: 更新记录
  - `get_record()`: 获取单条记录
  - `get_all_records()`: 获取所有记录
  - `search_records()`: 搜索记录
  - `delete_record()`: 删除记录

## 数据流程

### 完整工作流程：

```
1. 用户上传文件
   ↓
2. DocumentParser 解析文件 → 提取文本
   ↓
3. 保存到数据库（状态: draft）
   ↓
4. 用户点击"开始分析"
   ↓
5. ClaudeService.analyze_bidding_document()
   ├─ 构建分析提示词
   ├─ 调用 Claude API
   └─ 返回分析报告
   ↓
6. 保存报告到数据库（状态: analyzed）
   ↓
7. 用户点击"生成投标文件"
   ↓
8. ClaudeService.generate_bidding_response()
   ├─ 基于分析报告
   ├─ 调用 Claude API
   └─ 返回投标文件
   ↓
9. 保存到数据库（状态: completed）
   ↓
10. 用户下载报告和投标文件
```

## 技术栈

| 组件 | 技术 | 用途 |
|------|------|------|
| Web 框架 | Streamlit | 快速构建交互界面 |
| AI 模型 | Claude API (Anthropic) | 智能分析和生成 |
| PDF 处理 | PyMuPDF (fitz) | 解析 PDF 文件 |
| Word 处理 | python-docx | 解析 Word 文档 |
| Excel 处理 | openpyxl + pandas | 解析 Excel 表格 |
| 数据库 | SQLite + SQLAlchemy | 本地数据存储 |
| 环境管理 | python-dotenv | 环境变量配置 |

## 配置说明

### 环境变量（.env）

```bash
# 必需配置
ANTHROPIC_API_KEY=sk-ant-api03-xxx...

# 可选配置
MAX_FILE_SIZE_MB=50          # 最大文件大小（MB）
UPLOAD_FOLDER=uploads        # 上传目录
DATABASE_PATH=data/bidding_system.db  # 数据库路径
```

## 扩展性设计

### 1. 支持新文件格式

在 `modules/document_parser.py` 中添加新的解析方法：

```python
def parse_new_format(self, file_path: str) -> Dict[str, str]:
    # 实现解析逻辑
    pass

# 注册到 supported_formats
self.supported_formats['new_ext'] = self.parse_new_format
```

### 2. 添加新的文件类别

在 `app.py` 的 `file_upload_tab()` 中修改 `file_categories` 列表：

```python
file_categories = [
    {"name": "PDF规范", "types": ["pdf"], "help": "..."},
    {"name": "Word方案", "types": ["docx", "doc"], "help": "..."},
    # 添加新类别
    {"name": "新类别", "types": ["xxx"], "help": "..."},
]
```

### 3. 切换 AI 模型

在 `modules/ai_service.py` 中修改：

```python
self.model = "claude-opus-4-20250514"  # 使用更强大的模型
```

### 4. 自定义分析维度

修改 `modules/ai_service.py` 中的 `_build_analysis_prompt()` 方法，
调整提示词模板以增加或修改分析维度。

## 安全注意事项

1. **API Key 保护**：
   - `.env` 文件已加入 `.gitignore`
   - 不要将 API Key 提交到版本控制

2. **文件上传安全**：
   - 限制文件类型（仅 PDF/Word/Excel）
   - 建议设置文件大小限制

3. **数据隐私**：
   - 所有数据存储在本地
   - 仅文件内容发送到 Claude API
   - 建议定期清理 `uploads/` 目录

4. **生产环境部署**：
   - 添加用户认证
   - 使用 HTTPS
   - 配置访问控制

## 性能优化建议

1. **大文件处理**：
   - 对超长文本进行分块处理
   - 使用流式 API 调用（如果支持）

2. **缓存优化**：
   - Streamlit 的 `@st.cache_resource` 已用于服务初始化
   - 可增加文档解析结果缓存

3. **数据库优化**：
   - 添加索引（项目名称、创建时间）
   - 定期清理旧记录

4. **并发处理**：
   - 对于批量任务，可使用异步 API 调用
   - 考虑使用任务队列（Celery）

---

**版本**: v1.0.0
**更新日期**: 2026-01-14
**维护者**: Claude Code
