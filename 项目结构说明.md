# 项目结构说明

## 目录结构

```
智能标书审查系统 (对标智标领航)/
│
├── app.py                      # 【核心】Streamlit 主应用程序
│   ├── 文件上传功能 (6类文件)
│   ├── 标书分析界面 (7大类别解析)
│   └── 技术标生成界面 (目录+分步生成)
│
├── modules/                    # 【核心模块】
│   ├── __init__.py            # 模块初始化
│   │
│   ├── document_parser.py     # 文档解析模块
│   │   ├── PDF 解析 (PyMuPDF)
│   │   ├── Word 解析 (python-docx)
│   │   └── Excel 解析 (openpyxl/pandas，支持多sheet)
│   │
│   ├── ai_service.py          # Claude AI 服务封装
│   │   ├── parse_bidding_document_structured() - 7大类别解析 
│   │   ├── extract_evaluation_criteria() - 评审标准提取 
│   │   ├── generate_technical_proposal_outline() - 目录生成 
│   │   ├── generate_technical_proposal_section() - 章节生成 
│   │   └── chat() - 通用对话接口
│   │
│   ├── prompts.py             # AI提示词模板库 ✨新增
│   │   ├── BIDDING_DOCUMENT_ANALYSIS_PROMPT - 7大类别解析
│   │   ├── EVALUATION_CRITERIA_EXTRACTION_PROMPT - 评审标准提取
│   │   ├── TECHNICAL_PROPOSAL_OUTLINE_PROMPT - 技术标目录
│   │   └── TECHNICAL_PROPOSAL_SECTION_PROMPT - 技术标章节
│   │
│   └── database.py            # 数据库管理
│       ├── BiddingRecord ORM模型
│       ├── DatabaseManager - 项目记录 CRUD
│       └── 历史记录查询
│
├── database/                   # 【运行时生成】上传文件存储目录 ⚠️ 重要
│   └── (用户上传的 PDF/Word/Excel 文件，以时间戳命名)
│
├── data/                       # 【运行时生成】数据库文件目录
│   └── bidding_system.db      # SQLite 数据库
│
├── .streamlit/                 # Streamlit 配置目录
│   └── config.toml            # 应用配置
│
├── requirements.txt            # Python 依赖包列表
├── .env.example               # 环境变量配置模板
├── .env                       # 【需用户创建】实际环境配置
├── .gitignore                 # Git 忽略文件配置
│
├── README.md                  # 项目说明文档
├── 使用说明.md                # 用户操作手册
├── 使用指南.md                # 详细使用教程
├── 项目结构说明.md            # 本文件
│
├── test_setup.py              # 环境配置测试脚本
├── test_prompts.py            # 提示词测试脚本
├── 启动系统.bat               # Windows 快捷启动脚本（推荐）
├── start.bat                  # Windows 启动脚本（备用）
└── start.sh                   # Mac/Linux 启动脚本
```

**⚠️ 重要变更**:
- 上传文件存储在 `database/` 目录（非 `uploads/`）
- 新增 `modules/prompts.py` 模块化管理AI提示词
- 支持6类文件上传，均为可选项

## 核心模块详解

### 1. app.py - 主应用程序 (876行)

**功能**：
- Streamlit Web 界面
- 三个主要标签页：文件上传、标书分析、技术标生成
- Session 状态管理
- 历史记录加载与管理

**关键函数**：
- `main()`: 主函数，组织整体界面
- `init_services()`: 初始化服务（使用@st.cache_resource缓存）
- `file_upload_tab()`: 文件上传界面
  - 支持6类文件上传
  - 实时文件解析
  - 去重处理（基于文件ID）
- `analysis_tab()`: 标书分析界面
  - 调用7大类别结构化解析
  - 自动提取评审标准
  - 左右分栏显示（解析结果 | 原文对照）
- `generation_tab()`: 技术标生成界面
  - 生成技术标目录（JSON格式）
  - 显示目录树结构
  - 分步生成章节
  - 合并导出完整文档
- `load_record()`: 从数据库加载历史记录
- `reset_session()`: 重置会话状态
- `delete_record_with_files()`: 删除记录及关联文件
- `display_outline_tree()`: 递归显示目录树
- `extract_sections_from_outline()`: 从目录提取可生成章节
- `merge_all_sections()`: 合并所有章节为完整文档

**6类文件上传配置**:
```python
file_categories = [
    # 招标文件 (2类)
    {"name": "招标文件正文", "types": ["pdf", "docx", "doc", "xlsx", "xls"], "category": "招标文件"},
    {"name": "技术要求附件", "types": ["pdf", "docx", "doc", "xlsx", "xls"], "category": "招标文件"},

    # 招标文件附件 (4类)
    {"name": "工程量清单", "types": ["pdf", "xlsx", "xls", "docx", "doc"], "category": "招标文件附件"},
    {"name": "评审标准附件", "types": ["pdf", "docx", "doc", "xlsx", "xls"], "category": "招标文件附件"},
    {"name": "施工设计说明", "types": ["pdf", "docx", "doc", "dwg"], "category": "招标文件附件"},
    {"name": "方案建议书附件", "types": ["pdf", "docx", "doc", "xlsx", "xls"], "category": "招标文件附件"}
]
```

### 2. modules/document_parser.py - 文档解析 (175行)

**功能**：
- 支持 PDF、Word、Excel 格式文件解析
- 提取文本内容和元数据
- 中英文混合内容处理

**核心类**：
- `DocumentParser`: 文档解析器主类（注册模式）
  - `parse()`: 通用解析入口
  - `parse_pdf()`: PDF 解析（PyMuPDF）
    - 逐页提取文本
    - 返回页数元数据
  - `parse_word()`: Word 解析（python-docx）
    - 提取段落文本
    - 提取表格内容
  - `parse_excel()`: Excel 解析（pandas + openpyxl/xlrd）
    - 支持多工作表
    - 使用 `dtype=str` 保持原始格式
    - 支持中英文对齐显示

**返回格式**：
```python
{
    'content': '提取的文本内容',
    'metadata': {
        'type': '文件类型 (PDF/Word/Excel)',
        'pages': 页数,  # PDF
        'paragraphs': 段落数,  # Word
        'tables': 表格数,  # Word
        'sheets': 工作表数,  # Excel
        'sheet_names': ['Sheet1', ...],  # Excel
        'total_rows': 总行数,  # Excel
        'file_name': '文件名'
    }
}
```

### 3. modules/ai_service.py - AI 服务 (412行)

**功能**：
- 封装 Anthropic Claude API 调用
- 提供标书分析和技术标生成功能
- 支持自定义 base_url（如 OpenRouter）

**核心类**：
- `ClaudeService`: Claude AI 服务封装

**主要方法**（新版本）：
- `parse_bidding_document_structured(document_contents)` ✨ 核心
  - 7大类别结构化解析
  - max_tokens: 16000
  - temperature: 0.2（高准确性）
  - 使用 `BIDDING_DOCUMENT_ANALYSIS_PROMPT`

- `extract_evaluation_criteria(analysis_report)` ✨ 核心
  - 从解析报告提取评审标准
  - max_tokens: 8000
  - temperature: 0.3
  - 使用 `EVALUATION_CRITERIA_EXTRACTION_PROMPT`

- `generate_technical_proposal_outline(project_requirements, evaluation_criteria)` ✨ 核心
  - 生成技术标目录结构
  - 返回JSON格式（或原始文本）
  - max_tokens: 8000
  - temperature: 0.4
  - 使用 `TECHNICAL_PROPOSAL_OUTLINE_PROMPT`

- `generate_technical_proposal_section(section_title, word_count, ...)` ✨ 核心
  - 生成技术标单个章节
  - max_tokens: 8000
  - temperature: 0.5（适中创造性）
  - 使用 `TECHNICAL_PROPOSAL_SECTION_PROMPT`

**旧版方法**（已保留但不推荐）：
- `analyze_bidding_document()`: 分析标书（旧版本）
- `generate_bidding_response()`: 生成投标文件（旧版本）
- `chat()`: 通用对话接口

**配置**：
- 默认模型：`claude-sonnet-4-20250514`（Sonnet 4）
- 可选模型：`claude-opus-4-20250514`（Opus 4，更强但成本高）
- 支持环境变量：
  - `ANTHROPIC_API_KEY`: API密钥（必需）
  - `ANTHROPIC_BASE_URL`: 自定义API地址（可选，如OpenRouter）
  - `ANTHROPIC_MODEL`: 自定义模型名称（可选）

### 4. modules/prompts.py - 提示词模板库 ✨ 新增 (405行)

**功能**：
- 集中管理所有AI提示词模板
- 使用Python字符串格式化（f-string）

**4个核心提示词**：

1. **BIDDING_DOCUMENT_ANALYSIS_PROMPT** (160行)
   - 用途：7大类别结构化解析招标文件
   - 类别：基础信息、资格要求、评审要求、投标文件要求、无效标与废标项、应标需提交文件、招标文件审查
   - 格式：Markdown格式，层级清晰
   - 特色：
     - 明确标注提取位置
     - 风险识别（6大风险）
     - 公平性审查（5个维度）

2. **EVALUATION_CRITERIA_EXTRACTION_PROMPT** (53行)
   - 用途：从解析报告提取评审标准
   - 重点：施工组织设计评审因素
   - 输出：招标文件项目需求 + 详细评审标准
   - 格式：Markdown格式，包含评分细则

3. **TECHNICAL_PROPOSAL_OUTLINE_PROMPT** (127行)
   - 用途：生成技术标目录结构
   - 输入：项目需求 + 评审标准
   - 输出：JSON格式目录（含建议字数）
   - 参考结构：
     - 一、技术文件
     - 二、项目经理视频陈述及答辩
     - 三、施工组织设计（严格对应评审标准）

4. **TECHNICAL_PROPOSAL_SECTION_PROMPT** (55行)
   - 用途：生成技术标单个章节
   - 输入：章节标题、字数要求、章节要求、项目信息、评审标准
   - 输出：Markdown格式章节内容
   - 要求：
     - 紧密结合项目
     - 响应评审标准
     - 字数控制（±20%浮动）
     - 逻辑清晰、措施具体

### 5. modules/database.py - 数据库管理 (约150行)

**功能**：
- SQLite 数据库操作
- 项目记录的增删改查

**核心类**：
- `BiddingRecord`: 数据模型（SQLAlchemy ORM）
  - `id`: 主键（自增）
  - `project_name`: 项目名称
  - `uploaded_files`: 上传文件信息（JSON字符串）
  - `analysis_report`: 分析报告（7大类别解析结果）
  - `bidding_response`: 投标文件（实际存储评审标准）
  - `status`: 状态（draft/analyzed/completed）
  - `create_time`: 创建时间
  - `update_time`: 更新时间

- `DatabaseManager`: 数据库管理器
  - `create_record()`: 创建记录
  - `update_record()`: 更新记录
  - `get_record()`: 获取单条记录
  - `get_all_records()`: 获取所有记录
  - `search_records()`: 搜索记录
  - `delete_record()`: 删除记录

**数据库路径**: `data/bidding_system.db`

## 数据流程

### 完整工作流程（3个阶段）

```
阶段1: 文件上传 📄
┌──────────────────────────────────────────────┐
│ 1. 用户填写项目名称                          │
│ 2. 用户上传6类文件（均可选）                 │
│    - 招标文件正文                           │
│    - 技术要求附件                           │
│    - 工程量清单                             │
│    - 评审标准附件                           │
│    - 施工设计说明                           │
│    - 方案建议书附件                         │
│ 3. DocumentParser 实时解析文件 → 提取文本   │
│ 4. 保存到 session_state                     │
│ 5. 点击"保存项目" → 保存到数据库           │
│    status = 'draft'                         │
└──────────────────────────────────────────────┘
                    ↓
阶段2: 标书分析 📊
┌──────────────────────────────────────────────┐
│ 6. 用户点击"开始结构化解析"                  │
│    ↓                                         │
│ 7. ClaudeService.parse_bidding_document_     │
│    structured(uploaded_files_content)        │
│    ├─ 使用 BIDDING_DOCUMENT_ANALYSIS_PROMPT  │
│    ├─ 7大类别解析：                         │
│    │  1) 基础信息                            │
│    │  2) 资格要求                            │
│    │  3) 评审要求                            │
│    │  4) 投标文件要求                        │
│    │  5) 无效标与废标项                      │
│    │  6) 应标需提交文件                      │
│    │  7) 招标文件审查（6大风险 + 5维公平性） │
│    └─ 返回Markdown格式解析报告              │
│    ↓                                         │
│ 8. 保存解析报告到 session_state 和数据库    │
│    status = 'analyzed'                       │
│    ↓                                         │
│ 9. 自动调用 ClaudeService.extract_          │
│    evaluation_criteria(analysis_report)      │
│    ├─ 使用 EVALUATION_CRITERIA_EXTRACTION_   │
│    │  PROMPT                                 │
│    ├─ 提取招标文件项目需求                  │
│    └─ 提取评审标准（含评分细则）            │
│    ↓                                         │
│10. 保存评审标准到 session_state 和数据库    │
│11. 用户可导出解析报告（MD/TXT）             │
│12. 左右分栏显示：                            │
│    左侧：7大类别解析结果（可折叠）           │
│    右侧：原始文件内容（可切换文件）          │
└──────────────────────────────────────────────┘
                    ↓
阶段3: 技术标生成 📝
┌──────────────────────────────────────────────┐
│13. 用户点击"生成技术标目录"                  │
│    ↓                                         │
│14. ClaudeService.generate_technical_proposal_│
│    outline(project_requirements,             │
│             evaluation_criteria)             │
│    ├─ 使用 TECHNICAL_PROPOSAL_OUTLINE_PROMPT │
│    ├─ 基于项目需求和评审标准                │
│    └─ 返回JSON格式目录结构（含建议字数）    │
│    ↓                                         │
│15. 显示目录树（递归展示）                    │
│16. 提取可生成章节列表                        │
│    ↓                                         │
│17. 用户选择章节，点击"生成此章节"            │
│    ↓                                         │
│18. ClaudeService.generate_technical_proposal_│
│    section(section_title, word_count, ...)   │
│    ├─ 使用 TECHNICAL_PROPOSAL_SECTION_PROMPT │
│    ├─ 传入章节信息、字数要求、项目信息      │
│    └─ 返回Markdown格式章节内容              │
│    ↓                                         │
│19. 保存章节到 session_state.generated_      │
│    sections[section_title]                   │
│20. 显示已生成章节（可折叠）                  │
│21. 显示进度：X/Y 个章节已生成                │
│    ↓                                         │
│22. 重复步骤17-21，生成所有章节               │
│    ↓                                         │
│23. 用户点击"导出完整技术标"                  │
│    ↓                                         │
│24. merge_all_sections() 合并所有章节         │
│25. 导出为 MD/TXT 文件                        │
└──────────────────────────────────────────────┘
```

## 技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| Web 框架 | Streamlit | 1.31.0 | 快速构建交互界面 |
| AI 模型 | Claude Sonnet 4 | claude-sonnet-4-20250514 | 智能分析和生成 |
| AI SDK | anthropic | 0.18.1 | Anthropic API客户端 |
| PDF 处理 | PyMuPDF (fitz) | 1.23.22 | 解析 PDF 文件 |
| Word 处理 | python-docx | 1.1.0 | 解析 Word 文档 |
| Excel 处理 | openpyxl | 3.1.2 | 解析 Excel（.xlsx） |
| 数据处理 | pandas | 2.2.0 | Excel数据处理 |
| 数据库 | SQLite + SQLAlchemy | 2.0.27 | 本地数据存储 |
| 环境管理 | python-dotenv | 1.0.1 | 环境变量配置 |

## Session State 管理

Streamlit 使用 Session State 在页面重载间保持数据：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `current_record_id` | int/None | 当前项目数据库ID |
| `project_name` | str | 项目名称 |
| `uploaded_files_info` | Dict[str, str] | 文件信息 {类别: 文件名} |
| `uploaded_files_content` | Dict[str, str] | 文件内容 {类别: 文本内容} |
| `files_processed` | Set[str] | 已处理文件ID集合（去重用） |
| `analysis_report` | str/None | 7大类别解析报告全文 |
| `evaluation_criteria` | str/None | 评审标准 |
| `technical_outline` | Dict/None | 技术标目录结构（JSON） |
| `generated_sections` | Dict[str, str] | 已生成章节 {章节标题: 内容} |
| `bidding_response` | str/None | 投标文件（实际存评审标准） |

## 配置说明

### 环境变量（.env）

```bash
# 必需配置
ANTHROPIC_API_KEY=sk-ant-api03-xxx...

# 可选配置（OpenRouter等代理）
ANTHROPIC_BASE_URL=https://openrouter.ai/api/v1
ANTHROPIC_MODEL=anthropic/claude-sonnet-4

# 其他可选配置
MAX_FILE_SIZE_MB=50          # 最大文件大小（MB）
UPLOAD_FOLDER=database       # 上传目录
DATABASE_PATH=data/bidding_system.db  # 数据库路径
```

## 扩展性设计

### 1. 支持新文件格式

在 `modules/document_parser.py` 中添加新的解析方法：

```python
def parse_new_format(self, file_path: str) -> Dict[str, str]:
    # 实现解析逻辑
    return {
        'content': '提取的文本',
        'metadata': {'type': '新格式', ...}
    }

# 在 __init__ 中注册
self.supported_formats['new_ext'] = self.parse_new_format
```

### 2. 添加新的文件类别

在 `app.py` 的 `file_upload_tab()` 中修改 `file_categories` 列表：

```python
file_categories = [
    # 现有6类...
    # 添加新类别
    {
        "name": "新类别名称",
        "types": ["pdf", "docx"],
        "help": "类别说明",
        "category": "招标文件" # 或 "招标文件附件"
    },
]
```

### 3. 切换 AI 模型

在 `modules/ai_service.py` 中修改第49行：

```python
self.model = "claude-opus-4-20250514"  # 使用更强大的Opus模型
```

### 4. 自定义解析维度

修改 `modules/prompts.py` 中的 `BIDDING_DOCUMENT_ANALYSIS_PROMPT`，
在对应章节添加新的解析类别或子类别。

### 5. 修改技术标目录结构

修改 `modules/prompts.py` 中的 `TECHNICAL_PROPOSAL_OUTLINE_PROMPT`，
调整参考目录结构或增加新章节。

## 核心亮点

### 1. 智能提示词工程
- **模块化管理**: 所有提示词集中在 `prompts.py`，便于维护和版本控制
- **结构化输出**: 使用Markdown格式，便于解析和展示
- **引导式提取**: 明确指定提取位置和格式，减少AI幻觉
- **分步生成**: 将复杂任务拆分为多个步骤（解析→提取→目录→章节），提高准确性

### 2. 会话状态管理
- **持久化数据**: 关键数据同时保存到 session_state 和数据库
- **实时更新**: 文件上传、解析、生成等操作立即更新状态
- **去重机制**: 使用文件唯一ID防止重复解析
- **历史记录**: 支持加载历史项目，继续编辑

### 3. 文件处理机制
- **实时解析**: 文件上传时立即解析，无需等待
- **多格式支持**: PDF（逐页）、Word（段落+表格）、Excel（多工作表）
- **编码支持**: 完整支持中英文混合内容
- **元数据提取**: 页数、工作表数等元数据一并提取

### 4. 数据持久化
- **本地存储**: 文件保存在 `database/` 目录
- **数据库记录**: SQLite保存项目元数据和内容
- **关联删除**: 删除项目时自动清理关联文件
- **搜索功能**: 支持按项目名称搜索

### 5. 用户体验优化
- **进度提示**: 显示处理进度和预估token数
- **左右对照**: 解析结果和原文对照显示
- **分步生成**: 技术标分章节生成，可控性强
- **实时统计**: 显示章节字数、生成进度等

## 安全注意事项

1. **API Key 保护**：
   - `.env` 文件已加入 `.gitignore`
   - 不要将 API Key 提交到版本控制

2. **文件上传安全**：
   - 限制文件类型（仅 PDF/Word/Excel）
   - 建议设置文件大小限制
   - 文件名使用时间戳重命名，避免路径注入

3. **数据隐私**：
   - 所有数据存储在本地
   - 仅文件内容发送到 Claude API
   - 建议定期清理 `database/` 目录
   - 敏感项目建议使用私有部署的AI服务

4. **生产环境部署**：
   - 添加用户认证（Streamlit支持LDAP等）
   - 使用 HTTPS
   - 配置访问控制
   - 定期备份数据库

## 性能优化建议

1. **大文件处理**：
   - 当前限制：单次API调用最大16000 tokens
   - 优化：对超长文本进行分块处理
   - 优化：使用流式 API 调用（如支持）

2. **缓存优化**：
   - 已实现：`@st.cache_resource` 缓存服务初始化
   - 可增加：文档解析结果缓存（相同文件不重复解析）
   - 可增加：AI响应缓存（相同输入不重复调用）

3. **数据库优化**：
   - 建议：添加索引（项目名称、创建时间）
   - 建议：定期清理旧记录
   - 建议：大型部署考虑使用PostgreSQL

4. **并发处理**：
   - 当前：同步处理
   - 优化：批量任务使用异步 API 调用
   - 优化：考虑使用任务队列（Celery + Redis）

## 常见开发问题 FAQ

### Q1: 为什么上传目录是 database/ 而非 uploads/?
**A**: 历史遗留调整。初期使用 `uploads/`，后期为避免混淆统一改为 `database/`。所有代码已同步更新。

### Q2: 如何添加新的解析类别?
**A**: 修改 `modules/prompts.py` 中的 `BIDDING_DOCUMENT_ANALYSIS_PROMPT`，在对应大类别下添加新子类别。例如在"基础信息"下添加新字段，只需在相应位置加入提取项即可。

### Q3: 技术标目录为什么返回JSON?
**A**: 便于程序解析。AI返回JSON格式，前端可以：
- 递归显示树状结构
- 提取章节列表供生成
- 计算总体进度
- 如果AI返回失败，会fallback到原始文本格式（`raw: True`）

### Q4: 如何调整生成字数?
**A**: 在 `TECHNICAL_PROPOSAL_OUTLINE_PROMPT` 中修改各章节的 `word_count` 值。AI会根据建议字数控制输出长度（允许±20%浮动）。实际字数还受 `max_tokens` 限制。

### Q5: Session State 何时会丢失?
**A**:
- Streamlit应用重启
- 用户关闭浏览器标签页
- 长时间无操作（默认超时）

因此关键数据都会同步保存到数据库，用户可通过历史记录重新加载。

### Q6: 如何处理超长招标文件?
**A**:
- 当前策略：传入完整内容，依赖API的token限制
- 建议优化：
  1. 在 `parse_bidding_document_structured` 中添加文本截断逻辑
  2. 或使用分块解析 + 结果合并
  3. 或提高 `max_tokens` 到 API 上限

### Q7: 评审标准存储在哪个字段?
**A**: 存储在 `BiddingRecord.bidding_response` 字段。虽然字段名是 `bidding_response`，但实际用途已变更为存储评审标准。这是历史遗留命名，保留是为了数据库兼容性。

### Q8: 如何切换到 OpenRouter?
**A**: 在 `.env` 中配置：
```bash
ANTHROPIC_BASE_URL=https://openrouter.ai/api/v1
ANTHROPIC_MODEL=anthropic/claude-sonnet-4
```
代码会自动检测 `ANTHROPIC_BASE_URL` 并切换到自定义服务。

---

**版本**: v1.0.0
**更新日期**: 2026-01-15
**维护者**: Yecheng Zhang & Claude Code
**许可**: 内部使用
**仓库**: [待添加]
