# 重要问题总结

## 🎯 核心问题

### 问题1: 能看到解析后的原始数据吗？

✅ **可以！新增了导出功能。**

#### 在哪里查看？

**方式1: 导出为文件**
```
标书分析Tab
    ↓
点击"📥 导出原始数据"按钮
    ↓
下载TXT文件
    ↓
包含所有文件的完整文本（送入AI前的数据）
```

**文件内容示例**：
```
============================================================
文件类别: 招标文件正文
字符数: 128,456
============================================================
--- 第 1 页 ---
某某工程招标文件
第一章 招标公告
...

--- 第 237 页 ---
附件：评分标准
...


============================================================
文件类别: 施工设计说明
字符数: 85,234
============================================================
（施工设计说明的完整文本）
...
```

**方式2: 在界面直接查看**
```
标书分析Tab → 右侧"招标文件原文"
    ↓
选择文件下拉框
    ↓
查看任意文件的原始文本
```

---

### 问题2: 调用AI用什么模型？可以配置吗？

#### 当前使用模型

**默认**: `claude-sonnet-4-20250514` (Sonnet 4)

**位置**: `modules/ai_service.py` 第48行

#### 支持配置

✅ **现在支持通过 .env 配置！**

**配置方法**：

```bash
# 编辑 .env 文件

# 选项1: 默认模型（性价比高，推荐）
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# 选项2: 高性能模型（质量最高，贵5倍）
ANTHROPIC_MODEL=claude-opus-4-20250514

# 选项3: 经济型模型（最便宜，质量稍差）
ANTHROPIC_MODEL=claude-haiku-4-20250514
```

---

### 问题3: PyCharm的API配置会生效吗？

✅ **会的！而且优先级最高！**

#### 配置优先级

```
1. PyCharm Environment Variables  ← 最高优先级
2. .env 文件
3. 系统环境变量
4. 代码默认值
```

**验证方法**：
```
启动系统后，命令行会显示：
[AI Service] 使用模型: claude-opus-4-20250514
[AI Service] API端点: https://api.anthropic.com

如果显示 claude-opus-4 → 说明用的是昂贵模型
```

---

## ⚠️ 成本控制警告

### 如果PyCharm配置了Opus模型

**风险**：
- Opus 4 是 Sonnet 4 的 **5倍价格**
- 单次分析：$0.62 (Sonnet) vs **$3.15 (Opus)**
- 10次分析：$6.20 vs **$31.50**

**建议**：

#### 选项1: 修改PyCharm配置

```
Run → Edit Configurations
    ↓
Environment variables:
ANTHROPIC_MODEL=claude-sonnet-4-20250514  ← 改成Sonnet
```

#### 选项2: 创建专用API key

```
1. Anthropic控制台创建新API key
2. 设置spending limit（如：$10/月）
3. 在 .env 中使用这个key
4. PyCharm配置留空或注释掉
```

#### 选项3: 在代码中强制指定

```python
# modules/ai_service.py 第48行
# 强制使用Sonnet，忽略环境变量
self.model = "claude-sonnet-4-20250514"
```

---

## 📊 数据流程完整图

### 从上传到AI分析

```
┌─────────────────────────────────────┐
│ 用户上传PDF                         │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ DocumentParser.parse()              │
│ ├─ 文本层提取（快速，秒级）        │
│ └─ OCR识别（慢速，分钟级，仅扫描版）│
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 数据存储到内存                      │
│ st.session_state.uploaded_files_content = {
│   '招标文件正文': '完整文本...',
│   '施工设计说明': '完整文本...'
│ }                                   │
└─────────────────────────────────────┘
              ↓
       【此时可以导出查看】 ← 新增功能
              ↓
┌─────────────────────────────────────┐
│ 用户点击"开始结构化解析"            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ ClaudeService.parse_bidding_document_structured()
│ ├─ 读取: session_state.uploaded_files_content
│ ├─ 使用模型: claude-sonnet-4-20250514 (可配置)
│ └─ 发送给Claude API分析             │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 返回7类结构化分析报告                │
└─────────────────────────────────────┘
```

---

## 🧪 验证清单

### 数据准备验证

```
□ 上传文件后看到"✅ 已上传并解析"
□ 在"已上传文件"区域看到文件列表
□ 在"标书分析"Tab能看到"已加载文件"
□ 点击"导出原始数据"能下载TXT
□ TXT文件中有完整的文本内容
```

**全部✅ → 数据准备完整！**

### 模型配置验证

```
□ 启动时命令行显示使用的模型
□ 模型是 claude-sonnet-4（而非opus）
□ 分析时成本合理（约$0.6/次）
```

---

## 📝 配置文件清单

### 必须创建的文件

```
.env  ← 从 .env.example 复制并修改
```

### 推荐配置

```bash
# .env 文件内容

# API密钥（必填）
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx

# 模型选择（推荐Sonnet，性价比高）
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# 如果使用OpenRouter
# ANTHROPIC_BASE_URL=https://openrouter.ai/api/v1
# ANTHROPIC_MODEL=anthropic/claude-sonnet-4
```

---

## 🎯 立即行动

### 步骤1: 检查PyCharm配置

```
1. PyCharm → Run → Edit Configurations
2. 查看 Environment variables
3. 如果有 ANTHROPIC_MODEL=opus → 改成 sonnet
```

### 步骤2: 创建/修改 .env

```bash
# 复制模板
cp .env.example .env

# 编辑 .env
# 设置 ANTHROPIC_MODEL=claude-sonnet-4-20250514
```

### 步骤3: 重启服务

```bash
# Ctrl+C 停止
streamlit run app.py

# 查看命令行输出：
[AI Service] 使用模型: claude-sonnet-4-20250514  ← 确认是Sonnet
```

### 步骤4: 测试功能

```
1. 上传文件（观察实时进度）
2. 导出原始数据（验证数据完整）
3. 运行AI分析（确认模型正确）
```

---

## 💡 核心提醒

1. **200页PDF秒传是正常的** ✅（有文本层，不需要OCR）
2. **数据已完全准备好** ✅（可以导出查看验证）
3. **模型可以配置** ✅（避免用昂贵的Opus）
4. **PyCharm配置优先级最高** ⚠️（注意检查）

---

**最后更新**: 2026-01-19
**问题**: 数据查看 + 模型配置
**状态**: ✅ 已解决
