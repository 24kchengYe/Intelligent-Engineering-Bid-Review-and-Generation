# 新功能使用说明

## 📚 国标文件管理功能

### 功能介绍

在"国标管理"Tab中，您可以上传和管理国家标准、行业标准、地方标准文件。这些标准文件将独立存储，供以后的标书分析时参考对比。

### 使用场景

**场景1**: 建筑工程项目评审
```
上传标准:
- GB50500-2013 建设工程工程量清单计价规范
- JGJ59-2011 建筑施工安全检查标准
- CJJ1-2008 城市居住区规划设计标准

分析标书时:
系统可参考这些国标，检查招标文件要求是否符合国家标准
```

**场景2**: 市政工程项目
```
上传标准:
- GB50268 给水排水管道工程施工及验收规范
- CJJ123 市政工程施工质量验收规范
- DB11/T 695-2009 北京市地方标准

后续所有北京市政项目都可参考这些标准
```

### 操作步骤

#### 1. 上传国标文件

```
步骤:
① 切换到"国标管理"Tab
② 点击"选择标准文件"
③ 选择PDF或Word格式的标准文件
④ （可选）在"标准名称"框输入名称
   - 留空则自动从文件名提取
⑤ 点击"确认上传"

系统自动处理:
✓ 提取标准编号（如：GB50500-2013）
✓ 识别分类（国家标准/行业标准/地方标准）
✓ 计算文件哈希，防止重复上传
✓ 生成内容预览（前500字）
```

#### 2. 浏览国标库

```
顶部统计卡片显示:
┌──────┬──────┬──────┬──────┬──────┐
│ 总计 │国标  │行标  │地标  │ 其他 │
│ 15份 │ 8份  │ 5份  │ 2份  │ 0份  │
└──────┴──────┴──────┴──────┴──────┘

列表显示每个标准的:
- 标准编号
- 标准名称
- 分类
- 文件大小
- 上传时间
- 内容预览
```

#### 3. 查看完整内容

```
展开标准 → 点击"👁️ 查看" → 显示完整文本

可用于:
- 快速查阅标准条文
- 复制关键内容
- 对照招标文件要求
```

#### 4. 搜索国标

```
方式1: 关键词搜索
在"搜索标准"框输入:
- 标准编号: GB50500
- 标准名称关键词: 工程量清单
- 部分编号: 50500

方式2: 分类筛选
下拉选择:
- 全部
- 国家标准
- 行业标准
- 地方标准
- 其他
```

#### 5. 删除国标

```
展开标准 → 点击"🗑️ 删除" → 确认删除

注意:
⚠️ 删除后无法恢复
⚠️ 会同时删除文件和数据库记录
```

---

## 🔍 OCR扫描版PDF识别

### 功能介绍

系统自动检测PDF是否为扫描版（无文本层），并使用OCR技术识别文字。

### 识别原理

```
PDF页面判断:
① 提取文本层 → 如果文字<30字符 → 判定为扫描页
② 使用RapidOCR引擎识别图片文字
③ 过滤低置信度结果（<50%）
④ 返回识别文本 + 统计信息
```

### 使用示例

#### 案例1: 混合PDF（部分页面扫描）

```
上传文件: 招标文件.pdf（共20页）
- 第1-5页: 有文本层（直接提取）
- 第6-15页: 扫描版（OCR识别）
- 第16-20页: 有文本层（直接提取）

系统显示:
✅ 已上传并解析: 招标文件.pdf
📄 共 20 页
🔍 检测到扫描版PDF，已使用OCR识别 10/20 页
```

#### 案例2: 纯扫描版PDF

```
上传文件: 国标扫描件.pdf（共50页）
- 全部50页都是扫描版

系统显示:
✅ 已上传并解析: 国标扫描件.pdf
📄 共 50 页
🔍 检测到扫描版PDF，已使用OCR识别 50/50 页

⏱️ 识别时间: 约2-3分钟（取决于页数和清晰度）
```

### OCR质量说明

**识别准确率**:
- 高清扫描(≥300DPI): 95%+
- 普通扫描(150-300DPI): 85-95%
- 低质量扫描(<150DPI): <80%

**影响因素**:
- 扫描清晰度
- 文字大小
- 页面倾斜度
- 图像噪点

**最佳实践**:
✓ 使用≥300DPI扫描
✓ 保存为高质量PDF（勿过度压缩）
✓ 避免页面倾斜
✗ 不推荐拍照版PDF

---

## 📊 PDF表格结构化提取

### 功能介绍

系统可从PDF中识别表格，并提取为结构化二维数组（而非纯文本），便于AI分析。

### 提取效果对比

#### 传统方式（纯文本）:
```
序号 检测项目 要求
1 混凝土强度 ≥C30
2 钢筋规格 HRB400
...
（表格结构丢失，AI难以关联行列）
```

#### 结构化提取:
```python
table_data = [
    ['序号', '检测项目', '要求'],
    ['1', '混凝土强度', '≥C30'],
    ['2', '钢筋规格', 'HRB400']
]
（保留二维结构，AI可准确理解）
```

### 使用示例

```
上传文件: 评审标准.pdf

系统检测到表格:
📋 提取到 3 个表格

表格1: 评分标准
┌────────┬────────┬──────┐
│ 评审项 │ 分值   │ 标准 │
├────────┼────────┼──────┤
│ 方案   │ 30分   │ ...  │
│ 报价   │ 40分   │ ...  │
│ 业绩   │ 30分   │ ...  │
└────────┴────────┴──────┘

表格2、3...（以此类推）

metadata['tables'] = [
    {
        'page': 5,
        'data': [['评审项', '分值', '标准'], [...]]
    },
    ...
]
```

---

## 🎯 综合使用场景

### 场景: 完整的标书审查流程

```
第一步: 准备国标库
① 切换到"国标管理"Tab
② 上传相关国家标准（如GB50500、JGJ59等）
③ 上传行业标准（如CJJ1等）
④ 上传本地区地方标准

第二步: 上传招标文件
① 切换到"文件上传"Tab
② 上传招标文件（可能是扫描版）
   - 系统自动OCR识别
   - 提取表格结构
③ 上传附件（工程量清单、评审标准等）

第三步: AI智能分析
① 切换到"标书分析"Tab
② 点击"开始结构化解析"
③ AI参考国标库，分析招标文件
   - 对比国标要求
   - 识别风险点
   - 提取评审标准

第四步: 生成投标文件
① 切换到"投标文件生成"Tab
② 生成技术标目录
③ 逐章节生成内容
④ 导出完整技术标
```

---

## 📝 注意事项

### OCR功能

⚠️ **首次使用需下载OCR模型**（约30MB）
- 第一次识别时会自动下载
- 下载后存储在本地，后续无需重复下载

⚠️ **识别速度**
- 单页扫描版PDF: 1-3秒
- 50页扫描版PDF: 2-5分钟

⚠️ **内存占用**
- 高清PDF会占用较多内存
- 建议系统内存≥8GB

### 国标管理

⚠️ **文件去重**
- 基于SHA256哈希
- 相同内容的文件无法重复上传

⚠️ **标准编号唯一**
- 同一标准编号只能存在一个
- 如需更新，请先删除旧版本

⚠️ **存储位置**
- 国标文件存储在 `data/standards/`
- 不要手动删除此目录

### 表格提取

⚠️ **PyMuPDF版本要求**
- 需要 PyMuPDF ≥ 1.23
- 低版本不支持表格检测

⚠️ **复杂表格**
- 合并单元格可能识别不准确
- 旋转表格暂不支持

---

## 🆘 故障排查

### 问题1: OCR功能不工作

**现象**: 上传扫描版PDF后，未显示OCR统计

**排查**:
```bash
# 检查依赖是否安装
pip list | grep rapidocr

# 如未安装:
pip install rapidocr-onnxruntime==1.3.22
```

### 问题2: 国标上传失败

**现象**: 点击"确认上传"后提示错误

**可能原因**:
1. 文件已存在 → 检查是否重复上传
2. 标准编号重复 → 检查是否已有同编号标准
3. 权限不足 → 检查 `data/` 目录写权限
4. 文件损坏 → 尝试重新下载标准文件

**解决**:
```bash
# 查看详细错误
streamlit run app.py --logger.level=debug
```

### 问题3: 表格提取为空

**现象**: PDF明显有表格，但 metadata['tables_count'] = 0

**可能原因**:
1. PyMuPDF版本过低
2. 表格是图片（扫描版）
3. 表格格式特殊

**解决**:
```bash
# 升级PyMuPDF
pip install --upgrade PyMuPDF

# 如表格是扫描版，建议先OCR识别
```

---

## 💡 最佳实践

### 建议1: 定期维护国标库
```
- 每季度检查标准是否有更新
- 删除过期标准
- 上传新发布的标准
```

### 建议2: 文件命名规范
```
推荐格式:
GB50500-2013_建设工程工程量清单计价规范.pdf
JGJ59-2011_建筑施工安全检查标准.pdf

便于系统自动提取标准编号
```

### 建议3: 扫描件预处理
```
- 使用Adobe Acrobat等工具预先OCR
- 调整页面方向（纠正倾斜）
- 优化图像质量
```

---

**如有问题，请查阅《升级指南》或联系技术支持。**
