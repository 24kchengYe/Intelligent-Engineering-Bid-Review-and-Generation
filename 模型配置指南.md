# 模型配置指南

## 🎯 您的问题解答

### Q1: 调用AI解析标书用的什么模型？

**当前默认模型**：`claude-sonnet-4-20250514` (Sonnet 4)

**查看位置**：`modules/ai_service.py` 第48行

```python
self.model = os.getenv('ANTHROPIC_MODEL', 'claude-sonnet-4-20250514')
```

---

### Q2: 可以提前在.env里面配置吗？

**可以！** 现在支持通过 `.env` 文件配置模型。

---

### Q3: PyCharm settings里的API配置会生效吗？

**会的！** 优先级如下：

```
优先级1: PyCharm环境变量设置
    ↓
优先级2: .env 文件配置
    ↓
优先级3: 系统环境变量
    ↓
优先级4: 代码默认值
```

**所以您在PyCharm里设置的API会生效！**

---

## 🔧 配置方法

### 方法1: 使用 .env 文件配置（推荐）

#### 步骤1: 复制配置模板

```bash
# 如果还没有.env文件
cp .env.example .env
```

#### 步骤2: 编辑 .env 文件

```bash
# ============ Claude API 配置 ============

# API密钥（必填）
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx

# 模型选择（可选）
# 默认：claude-sonnet-4-20250514 (性价比高)
# 如果想用更强的模型：
ANTHROPIC_MODEL=claude-opus-4-20250514

# 如果想用便宜的模型测试：
# ANTHROPIC_MODEL=claude-haiku-4-20250514
```

#### 步骤3: 重启服务

```bash
# Ctrl+C 停止
streamlit run app.py
```

---

### 方法2: PyCharm环境变量配置

#### 步骤1: 打开Run Configuration

```
PyCharm → Run → Edit Configurations
```

#### 步骤2: 添加环境变量

```
Environment variables:
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx
ANTHROPIC_MODEL=claude-opus-4-20250514
```

#### 步骤3: 运行

```
在PyCharm中点击运行按钮
环境变量会自动生效
```

**注意**：
- ✅ PyCharm的环境变量**会覆盖** .env文件
- ✅ 适合：每个开发者用不同的API key

---

## 📊 模型对比

### Claude官方模型（推荐）

| 模型 | 性能 | 速度 | 价格 | 适用场景 |
|-----|------|------|------|---------|
| **Sonnet 4** | ⭐⭐⭐⭐ | ⚡⚡⚡ | 💰💰 | **默认，性价比最高** |
| **Opus 4** | ⭐⭐⭐⭐⭐ | ⚡⚡ | 💰💰💰💰 | 复杂分析、高质量生成 |
| **Haiku 4** | ⭐⭐⭐ | ⚡⚡⚡⚡⚡ | 💰 | 测试、简单任务 |

### 价格参考（Anthropic官方定价）

| 模型 | Input（/1M tokens） | Output（/1M tokens） |
|-----|-------------------|---------------------|
| Haiku 4 | $0.40 | $2.00 |
| **Sonnet 4** | **$3.00** | **$15.00** |
| Opus 4 | $15.00 | $75.00 |

### 使用建议

#### 场景1: 日常使用（推荐）

```bash
# .env 配置
ANTHROPIC_MODEL=claude-sonnet-4-20250514
```

**特点**：
- ✅ 性能优秀（接近Opus）
- ✅ 价格合理（是Opus的1/5）
- ✅ 速度快

#### 场景2: 测试开发

```bash
# .env 配置
ANTHROPIC_MODEL=claude-haiku-4-20250514
```

**特点**：
- ✅ 价格最便宜（是Sonnet的1/8）
- ✅ 速度最快
- ⚠️ 分析深度稍弱

#### 场景3: 重要项目/高质量需求

```bash
# .env 配置
ANTHROPIC_MODEL=claude-opus-4-20250514
```

**特点**：
- ✅ 最强性能
- ✅ 最详细的风险分析
- ❌ 价格最贵（是Sonnet的5倍）

---

## 🔍 PyCharm配置生效验证

### 如何确认配置生效？

**方法1: 查看启动日志**

当您运行系统时，会在命令行看到：

```bash
[AI Service] 使用模型: claude-opus-4-20250514
[AI Service] API端点: https://api.anthropic.com
```

**方法2: 临时添加调试代码**

在 `app.py` 的 `main()` 函数中添加：

```python
def main():
    ai_service, db_manager, document_parser, standards_manager = init_services()

    # 临时调试：显示模型信息
    st.sidebar.info(f"当前使用模型: {ai_service.model}")
```

---

## 🎯 您的具体情况

### 如果PyCharm已配置好的API

```
您说：PyCharm settings里已经设置了默认环境使用的API
这个API调用的模型很好也很贵
```

**可能的情况**：
1. ANTHROPIC_API_KEY 已在PyCharm配置
2. 可能还配置了 ANTHROPIC_MODEL

**验证方法**：
```
PyCharm → Run → Edit Configurations
    ↓
查看 Environment variables:
    ↓
如果有 ANTHROPIC_MODEL=claude-opus-4-xxx
    ↓
说明会使用Opus（最贵的模型）
```

### 如何避免使用昂贵模型

#### 选项1: 修改PyCharm配置

```
PyCharm → Edit Configurations
    ↓
Environment variables 修改为:
ANTHROPIC_API_KEY=sk-ant-xxx
ANTHROPIC_MODEL=claude-sonnet-4-20250514  ← 改成Sonnet
```

#### 选项2: 在.env中覆盖

```bash
# .env 文件（会被PyCharm环境变量覆盖）
# 所以这个方法不行，必须改PyCharm配置
```

#### 选项3: 创建专用的API key

```
在Anthropic控制台：
1. 创建新的API key
2. 设置spending limit（花费限制）
3. 在.env中使用这个新key

这样就不会影响PyCharm的全局配置
```

---

## 📋 配置文件示例

### .env 完整配置

```bash
# ============ Claude API 配置 ============

# 方案A: 使用官方API + 经济型模型
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# 方案B: 使用官方API + 高性能模型（贵！）
# ANTHROPIC_API_KEY=sk-ant-api03-xxxxx
# ANTHROPIC_MODEL=claude-opus-4-20250514

# 方案C: 使用OpenRouter（可能更便宜）
# ANTHROPIC_BASE_URL=https://openrouter.ai/api/v1
# ANTHROPIC_API_KEY=sk-or-xxxxx
# ANTHROPIC_MODEL=anthropic/claude-sonnet-4

# ============ 其他配置 ============
MAX_FILE_SIZE_MB=50
```

---

## 💰 成本估算

### 典型标书分析的token消耗

```
输入（招标文件）：
- 50页PDF ≈ 20,000 tokens
- 200页PDF ≈ 80,000 tokens

输出（分析报告）：
- 结构化解析 ≈ 8,000 tokens
- 评审标准提取 ≈ 3,000 tokens
- 技术标生成 ≈ 15,000 tokens

总计: 约 100,000 tokens (0.1M tokens)
```

### 价格对比（单次分析）

| 模型 | Input成本 | Output成本 | 合计 |
|-----|----------|-----------|------|
| Haiku 4 | $0.03 | $0.05 | **$0.08** |
| **Sonnet 4** | $0.24 | $0.38 | **$0.62** |
| Opus 4 | $1.20 | $1.95 | **$3.15** |

**结论**：
- Sonnet 4 是最佳选择（性价比）
- Opus 4 是 Sonnet 的 **5倍价格**

---

## 🎯 总结

### Q1: 能看到原始数据吗？

**可以！** 现在有两种方式：

1. **在"标书分析"Tab**：
   - 点击"📥 导出原始数据"按钮
   - 下载TXT文件查看

2. **在"标书分析"Tab右侧**：
   - 选择文件查看原始文本

### Q2: 模型配置在.env中？

**可以！** 已支持：

```bash
# .env 文件
ANTHROPIC_MODEL=claude-sonnet-4-20250514  # 默认
# ANTHROPIC_MODEL=claude-opus-4-20250514  # 高性能（贵5倍）
# ANTHROPIC_MODEL=claude-haiku-4-20250514 # 便宜（质量稍差）
```

### Q3: PyCharm配置会生效吗？

**会的！** 而且**优先级最高**（会覆盖.env）

**建议**：
- 如果PyCharm配置了昂贵模型 → 改成Sonnet或创建新API key
- 启动时会显示：`[AI Service] 使用模型: claude-opus-4-xxx`

---

**现在请**：
1. ⏹️ 停止服务（Ctrl+C）
2. 📝 检查PyCharm环境变量（避免用昂贵模型）
3. 🔄 重新启动
4. 🧪 测试上传文件，应该能看到实时进度了！