# 大文件上传问题排查

## 🔍 问题现象

**用户反馈**: 15MB的"施工设计说明.pdf"上传不上去，但1.5MB的"招标文件正文.pdf"可以

## ✅ 实际情况

经检查，文件**已经上传成功**！

```bash
database/
├── 施工设计说明_20260119_184555.pdf  (15MB) ← 上传成功
├── 施工设计说明_20260119_184912.pdf  (15MB) ← 重复上传（已修复）
└── 招标文件正文_20260119_184900.pdf  (2MB)
```

## 🐛 真正的问题

### 问题1: 解析时间过长导致误判

**原因**:
- 15MB的PDF可能有几十页甚至上百页
- 如果是扫描版，每页需要OCR识别（1-3秒/页）
- 总计可能需要**1-3分钟**才能完成
- 用户以为"没有上传成功"，实际上是**正在处理中**

### 问题2: 缺少处理进度反馈

**旧代码**: 没有任何进度提示
```python
# 用户点击上传后...
parsed_result = document_parser.parse(file_path)  # 这里可能要等2分钟
# 用户看不到任何反馈，以为卡住了
```

### 问题3: 大文件没有警告

**旧代码**: 没有提示用户需要等待

---

## ✅ 已修复

### 修复1: 添加大文件警告

```python
file_size_mb = uploaded_file.size / 1024 / 1024

# 超过10MB显示警告
if file_size_mb > 10:
    st.warning(f"⚠️ 文件较大({file_size_mb:.1f}MB)，解析可能需要1-3分钟，请耐心等待...")
```

**效果**:
- 上传15MB文件时，会看到 "⚠️ 文件较大(15.2MB)，解析可能需要1-3分钟，请耐心等待..."
- 用户知道需要等待，不会误判为失败

### 修复2: 添加处理进度提示

```python
with st.spinner(f"正在处理 {uploaded_file.name}..."):
    # 保存文件
    # 解析文件（这里可能很慢）
```

**效果**:
- 显示旋转加载动画
- 提示"正在处理 施工设计说明.pdf..."
- 用户知道系统正在工作

### 修复3: 显示文件大小

```python
st.success(f"✅ 已上传并解析: {uploaded_file.name} ({file_size_mb:.1f}MB)")
```

**效果**:
- 成功后显示 "✅ 已上传并解析: 施工设计说明.pdf (15.2MB)"
- 确认文件大小无误

### 修复4: 添加详细错误信息

```python
except Exception as e:
    st.error(f"❌ 解析失败: {str(e)}")
    import traceback
    st.error(traceback.format_exc())  # 显示完整错误堆栈
```

**作用**:
- 如果真的失败，可以看到具体错误原因
- 便于排查问题

---

## 🧪 解决方案验证

### 测试场景1: 上传小文件（<10MB）

```
操作:
1. 上传"招标文件正文.pdf"（2MB）

预期:
✅ 不显示警告
✅ 快速完成（<5秒）
✅ 显示"✅ 已上传并解析: 招标文件正文.pdf (2.0MB)"
```

### 测试场景2: 上传大文件（>10MB）

**当前测试**: 上传"施工设计说明.pdf"（15MB）

```
操作:
1. 点击"施工设计说明"上传按钮
2. 选择15MB的PDF文件

预期显示顺序:
① ⚠️ 文件较大(15.2MB)，解析可能需要1-3分钟，请耐心等待...
② 🔄 正在处理 施工设计说明.pdf...（旋转动画）
③ 等待1-3分钟（取决于页数和是否需要OCR）
④ ✅ 已上传并解析: 施工设计说明.pdf (15.2MB)
⑤ 📄 共 XX 页
⑥ （如果有OCR）🔍 检测到扫描版PDF，已使用OCR识别 X/X 页
```

---

## 📊 性能参考

### PDF解析时间估算

| 文件大小 | 页数 | 类型 | 预计时间 |
|---------|------|------|---------|
| 1-5MB | 10-20页 | 文本层 | 2-5秒 |
| 1-5MB | 10-20页 | 扫描版 | 20-60秒 |
| 10-20MB | 50-100页 | 文本层 | 10-30秒 |
| 10-20MB | 50-100页 | 扫描版 | **2-5分钟** |
| 50MB+ | 200+页 | 扫描版 | **10分钟+** |

### OCR性能

- **速度**: 1-3秒/页（取决于清晰度和内容复杂度）
- **内存**: 每页约50-100MB峰值内存
- **CPU**: 单核处理，无并行

---

## 💡 用户操作建议

### 上传大文件时

1. **看到警告后**: 不要关闭页面或刷新，耐心等待
2. **看到旋转动画**: 说明正在处理，不是卡死
3. **等待时间**:
   - 文本层PDF：几秒到1分钟
   - 扫描版PDF：1-5分钟（取决于页数）
4. **成功标志**: 看到 "✅ 已上传并解析" 提示

### 如果真的失败

**表现**:
- 显示 "❌ 解析失败: ..."
- 有具体错误信息

**解决方法**:
1. 检查PDF是否损坏
2. 尝试用PDF阅读器打开验证
3. 如果是加密PDF，需要先解密
4. 如果文件过大（>50MB），考虑拆分

---

## 🔧 配置说明

### Streamlit文件大小限制

配置文件: `.streamlit/config.toml`

```toml
[server]
# 文件上传大小限制（MB）
maxUploadSize = 200
```

**当前限制**: 200MB
**建议**: 保持默认，足够使用

### 如需调整限制

```toml
# 增加到500MB
maxUploadSize = 500
```

**注意**:
- 过大的限制会占用大量内存
- 建议根据实际需求设置
- 当前200MB已足够处理大部分标书

---

## 🎯 关键提示

### 现在上传15MB文件的流程

```
① 选择文件 → ② 看到警告（15.2MB，需等1-3分钟）
    ↓
③ 看到进度提示（正在处理...）
    ↓
④ 等待（不要关闭页面！）
    ↓
⑤ 成功提示（✅ 已上传并解析 15.2MB）
    ↓
⑥ 在"已上传文件"看到文件
    ↓
⑦ 点击"保存项目"
```

### 常见误解

❌ **误解**: 没有立即显示成功，就是失败了
✅ **真相**: 大文件需要1-3分钟处理时间

❌ **误解**: 界面没反应，系统卡住了
✅ **真相**: 旋转动画表示正在处理

❌ **误解**: 文件上传失败了
✅ **真相**: 文件已经保存到database目录，只是正在解析

---

## 📋 检查清单

如果怀疑上传失败，请按以下步骤检查：

### Step 1: 检查物理文件

```bash
# 查看database目录
ls -lh database/

# 查找特定文件
ls database/ | grep 施工设计说明
```

**如果文件存在** → 说明已上传成功，只是解析慢

### Step 2: 检查session_state

在代码中添加调试信息（临时）:
```python
st.write("已上传文件:", st.session_state.uploaded_files_info)
```

**如果有记录** → 说明解析也成功了

### Step 3: 查看错误日志

如果有报错，会显示在界面上：
```
❌ 解析失败: [具体错误信息]
[错误堆栈]
```

根据错误信息排查

---

## 🆘 紧急处理

### 如果等待超过5分钟还没反应

**可能原因**:
1. PDF页数过多（>200页）
2. 扫描版质量极差导致OCR很慢
3. 内存不足

**解决方案**:
1. 刷新页面（会丢失进度）
2. 检查database目录，如果文件已存在：
   - 手动删除文件
   - 重新上传小一点的文件测试
3. 考虑禁用OCR:
   ```python
   # 在 app.py 第25行修改
   document_parser = DocumentParser(enable_ocr=False)
   ```

---

**最后更新**: 2026-01-19
**问题严重程度**: 🟡 Medium（用户体验问题，非功能性故障）
**修复状态**: ✅ 已优化（添加进度提示和警告）
